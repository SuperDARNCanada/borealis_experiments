#!/usr/bin/python

"""
Experiment fault:
    Decimation stage filter taps not a list
"""

import borealis_experiments.superdarn_common_fields as scf
from experiment_prototype.experiment_prototype import ExperimentPrototype
from experiment_prototype.experiment_utils.decimation_scheme import \
    DecimationScheme, DecimationStage, create_firwin_filter_by_attenuation
from experiment_prototype.experiment_utils.decimation_scheme import create_default_scheme
from experiment_prototype.experiment_exception import ExperimentException


class TestExperiment(ExperimentPrototype):

    def __init__(self):
        cpid = 1

        # Filter_taps is not a list
        rates = [5.0e6, 500.0e3, 100.0e3, 50.0e3/3]
        dm_rates = [10, 5, 6, 5]
        transition_widths = [150.0e3, 40.0e3, 15.0e3, 1.0e3]
        cutoffs = [20.0e3, 10.0e3, 10.0e3, 5.0e3]
        ripple_dbs = [150.0, 80.0, 35.0, 9.0]
        scaling_factors = [10.0, 100.0, 100.0, 100.0]
        all_stages = []
        for stage in range(0, len(rates)):
            filter_taps = list(
                scaling_factors[stage] * create_firwin_filter_by_attenuation(
                    rates[stage], transition_widths[stage], cutoffs[stage],
                    ripple_dbs[stage]))
            all_stages.append(DecimationStage(stage, rates[stage],
                              dm_rates[stage], set(filter_taps)))  ### filter_taps is not a list, should fail

        # changed from 10e3/3->10e3
        decimation_scheme = (DecimationScheme(rates[0], rates[-1]/dm_rates[-1], stages=all_stages))
        super(TestExperiment, self).__init__(
            cpid, output_rx_rate=decimation_scheme.output_sample_rate,
            decimation_scheme=decimation_scheme)

        if scf.IS_FORWARD_RADAR:
            beams_to_use = scf.STD_16_FORWARD_BEAM_ORDER
        else:
            beams_to_use = scf.STD_16_REVERSE_BEAM_ORDER

        if scf.options.site_id in ["cly", "rkn", "inv"]:
            num_ranges = scf.POLARDARN_NUM_RANGES
        if scf.options.site_id in ["sas", "pgr"]:
            num_ranges = scf.STD_NUM_RANGES

        slice_1 = {  # slice_id = 0, there is only one slice.
            "pulse_sequence": scf.SEQUENCE_7P,
            "tau_spacing": scf.TAU_SPACING_7P,
            "pulse_len": scf.PULSE_LEN_45KM,
            "num_ranges": num_ranges,
            "first_range": scf.STD_FIRST_RANGE,
            "intt": 3500,  # duration of an integration, in ms
            "beam_angle": scf.STD_16_BEAM_ANGLE,
            "rx_beam_order": beams_to_use,
            "tx_beam_order": beams_to_use,
            "scanbound": [i * 3.5 for i in range(len(beams_to_use))], #1 min scan
            "freq" : scf.COMMON_MODE_FREQ_1, #kHz
            "acf": True,
            "xcf": True,  # cross-correlation processing
            "acfint": True,  # interferometer acfs
            "decimation_scheme": decimation_scheme,
        }
        self.add_slice(slice_1)

    @classmethod
    def error_message(cls):
        return ExperimentException, \
            "Filter taps {0.06289466724896364, -0.0010733131978737358, 0.0034739473230933704, 0.08225352451182923, 3.8736815548755935e-08, -0.0003365289888721362, 3.4897229020296903e-07, 0.0695951435514344, -0.000480057381930764, -0.0024009882540009953, 1.525146324717017e-08, 9.601880324662872e-06, 6.608587739736533e-07, -0.00016656726614700716, -0.0022723317036880673, -0.0016715904235526304, -0.0006259778310093054, -0.0002094213323572842, 0.07634050450522707, 0.0106603162082833, -0.0023209924921151776, -0.0022170321752018897, 0.02202242256928963, 0.07742532989277437, 0.01961658218455495, 8.656110753604306e-06, -0.0015284578439195467, 0.00311186718534993, 0.05246321634635108, 5.916082120294521e-06, 2.206181197828724e-06, 8.31958089807559e-06, -0.0009494006071805216, -0.0023741416143331384, -9.158646873676331e-06, 0.044474664856345325, -0.0006911903688554466, -0.0008710245542883229, -0.0009898869300578451, 0.0012238590423045022, -2.6700248795790924e-05, 0.01448547446571537, -4.6927550412560446e-05, 5.587216209820598e-06, 3.998349768150298e-07, -0.0019527138712386045, 0.039488918105640064, 0.0646579013169585, 0.022850152522714638, 9.727379207166697e-06, -0.0012398028883716249, 0.08248346019377377, -0.000295966757047972, -0.0001301713473561059, 5.265893055101848e-06, 6.936630970229283e-06, -1.7930139381572334e-20, 1.145744914222454e-06, 0.0817809903523374, 2.0236773618653963e-06, 7.283516730366471e-06, 0.0018003197798039563, -0.00022500176418186612, 5.862064728909546e-07, 6.592084651684843e-06, 0.01733226200494296, -0.0023448070313587697, 0.006409896594214745, 0.018841320531247194, -9.949928935860894e-05, -0.0020416727959042917, 1.072105188825564e-05, -0.00134044547650692, -0.00024151879218492644, 0.008413656338717823, 1.1462731497374251e-07, 0.006888224518248666, -0.0024464487464716965, 8.313013071426383e-07, 5.180756075436137e-07, 0.04748202391696512, 0.07322733954560626, 0.005497987864126837, -3.604067103754201e-05, -0.0013869177812535149, 1.630849982118407e-07, 0.007381582840818176, -0.0017308486273283738, 0.05047951717977588, 0.05637020863639402, 0.057330221475522074, -2.256329274414122e-05, -0.0005354982526097347, 0.07516197231547955, 0.07886881128252848, 0.07970377954383184, 0.029888851116174845, 0.0009547146941380543, 1.3730619869641689e-07, 0.05344857851244929, -0.002167116474271743, 1.0151210931692294e-05, 1.0968593941858368e-05, -0.0005949127718093778, 0.02040535791763117, 0.01126006210510896, -0.00045378543991217744, 0.05540278724658995, 0.08235405470373033, 0.04048044299550955, 1.6908671985746142e-06, 0.05442867261903071, 0.00045346041199266593, 2.1692138188908925e-08, 0.012505081755886823, 0.0355690403475698, -0.00020926850658720052, 0.008952470327740493, -0.0019241158571979655, -0.0010936785623917133, 2.3997275272667507e-06, -0.0001416384354536527, 6.893936394546042e-06, -0.0005646791231571291, 0.05147329442618035, -0.0018316094229349966, -0.0007962628392915341, -0.0012944378446069925, -6.649832703027695e-05, 0.07035960997716854, 0.07453881083873386, 0.018079808020846345, -0.0012489546615515699, -0.002491035919873828, -4.110307107626933e-06, -0.00040763984980213367, 0.04347314441125988, 0.028064904788379367, 7.424251342076469e-07, -0.002464664890689465, 0.025406406637780994, 0.007890041340352606, 0.06378282944908116, 0.07110567363567229, 0.0784127263720031, 1.7390766626423138e-06, -0.001433790551060219, 0.00022087753900598367, 0.07254013599442419, -0.00038065769245545437, 0.048483190537792244, -0.00010912347465243661, 6.251441430724166e-06, 0.042473177377907664, 0.03175006199386798, 0.06108187135546527, -0.002488055736150857, 0.07793142728177971, 1.048157713433648e-18, 3.0481814907737657e-06, 0.005946516218467315, 6.254755780767991e-08, 0.021207394911218383, 0.07929928693128875, -0.002497435583084663, -0.0007252552261758124, 0.046479766087839575, 0.05922515725189695, 0.08105521614904057, 0.002429115361732433, 3.799273256474238e-06, 0.013150244251379149, -1.5266453654540216e-05, 1.54000892264513e-06, 4.649336493175233e-06, 0.04547709110451463, -0.0020854545539949515, -0.0021265579956648052, 0.016598882191637684, -0.0024251560420184845, 0.08246907333454662, -0.0024297559197984926, -5.951595955482316e-05, 0.08212442362785628, -4.128125873174736e-05, 0.002108071424421339, -0.0024544610304810055, -0.00018007205277773653, -0.0004040962927861809, -0.001159779264374637, 0.002763650442432735, 1.0974104396405544e-05, -0.0014809950371240943, 0.08132496494423744, -0.002399445992839946, -8.194238715866198e-05, 0.03654091959760706, 4.560786615966971e-07, -0.002279410655343552, -0.0015034720365777578, -0.0013763102602103565, -0.0024795978433219752, 0.06719768019427408, 2.619506572776292e-07, 1.3990993373858622e-06, 0.003850063349973732, 0.027168005364606732, 0.030815026614753223, 3.28542585637886e-06, 8.983995021377113e-06, 4.953012724983122e-06, 3.537596842711744e-06, 1.0325682164026036e-06, 7.977066439096651e-06, 9.885216922940113e-06, 0.08008193713562287, 0.05828210969100015, 0.08043342996708851, 1.2677976203724372e-06, 0.08242592546680576, 2.251002403810694e-07, -0.0012040513839653522, -0.000658096113070276, -0.000771500714345233, 4.96984486342935e-08, 0.07689487035035975, 5.850790244901255e-06, 1.088337650374436e-05, -0.0018139390414664727, 0.011874999820488966, 0.08156696057641506, 2.8206225823486905e-06, -0.0020846945161923478, -0.000833182058539254, 2.6044971758924117e-06, -0.0018607444369520907, -9.044609231282396e-05, 4.35549696550302e-06, 0.0006979930404067116, -0.0019070424543745927, 9.300314863763255e-06, 0.07183271711995307, 0.07389375151868346, -0.0025025561317611146, -5.299913249536603e-05, 4.0720078346828775e-06, 0.00950651160781722, 1.0381801829536081e-05, 0.02454247716865664, -0.0007602828542883173, 1.047964050270924e-05, -0.002498762495863228, 0.041475401287418334, -1.945166613773851e-06, 0.004240378072983618, 0.07576270733041814, -0.0019976340304188444, 0.060158648978224226, -0.0002588393089865985, -0.0016215605297766622, 1.0146552138739823e-05, 1.1000295935293669e-05, 0.015879850736619606, -0.0011161854690177769, 1.8519927447572555e-06, 0.005064203732491989, 1.922496480229604e-07, 0.03751857137598318, -0.002502190709845202, -6.509826143199113e-06, 0.03364479107221002, 0.0807579509706507, -0.0017192561495253307, -0.000909771406807081, -0.0015761008273510904, 0.06199411335353473, 7.792624870566256e-06, 1.0756068275015736e-05, -0.0001193402643357173, -0.0016238409971062475, -3.1186593826643534e-05, 0.08196686594268496, 9.278839615312733e-07, 0.02897199583990937, 1.0885236198501121e-05, -0.00019429881069767612, 3.2871902683031636e-06, 0.023690278657604633, 8.557647635737622e-06, -0.0017667401073523435, 7.630983599570356e-06, 0.06881290397321826, 0.06551918999587059, -0.0021548288421496787, 0.013810407330902556, -7.396684131510267e-05, -0.002363277236350318, 0.034603485095254245, -0.00031580995158641254, -0.000358139896049816, -0.0005072927054517898, -0.0024738119586286025, -0.0002769824642020327, 0.026281708138255495, -0.0004284684074119294, -0.0023131700220996028, -0.0020086403684454724, 7.749770595358078e-08, -0.0009376672646191548, 0.03269348085846506, 0.038501430413861934, -0.002243703505338492, 0.0015056537011587817, 2.9463235340704388e-08, 0.015175332356763542, 0.0046450441666391834, 0.06801353228963597, -0.0010312018065974904, -0.0022062176158428814, 3.031280692631285e-07, 0.010075793939417774, 9.199298196946883e-06, -1.2072207088245197e-05, -0.0005948385597234552, 0.06636600923202082, 0.04948258440617524, 1.05865566153314e-05, -1.875783517136941e-05, -0.00015376321007033492, 9.477681572350969e-08, 4.651889343061061e-06} of type <class 'set'> must be a list in decimation stage 0"
